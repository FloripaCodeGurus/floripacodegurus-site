name: Deploy Django App to AWS EC2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run tests
      run: |
        python manage.py test --settings=configs.settings.development
        
    - name: Create deployment package
      run: |
        tar -czf deployment.tar.gz \
          --exclude='venv' \
          --exclude='__pycache__' \
          --exclude='.git' \
          --exclude='*.pyc' \
          --exclude='.env*' \
          --exclude='deployment.tar.gz' \
          --exclude='.github' \
          .
          
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
        
    - name: Add EC2 to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to EC2
      run: |
        # Upload deployment package
        scp deployment.tar.gz ec2-user@${{ secrets.EC2_HOST }}:/tmp/
        
        # Deploy on EC2
        ssh ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          
          echo "üöÄ Starting deployment..."
          
          # Navigate to application directory
          cd /opt/floripacodegurus
          
          # Stop current containers
          docker-compose -f docker-compose-simple.yml down || true
          
          # Backup current deployment
          if [ -d "app_backup" ]; then
            rm -rf app_backup
          fi
          if [ -d "app" ]; then
            mv app app_backup
          fi
          
          # Extract new deployment
          mkdir -p app
          cd app
          tar -xzf /tmp/deployment.tar.gz
          
          # Copy environment file
          cp ../.env.production .env.production || echo "No .env.production found"
          
          # Move back to application directory
          cd ..
          
          # Copy new files
          cp -r app/* .
          rm -rf app
          
          # Set permissions
          chmod +x docker-entrypoint-simple.sh
          
          # Build and start containers
          docker-compose -f docker-compose-simple.yml build --no-cache web
          docker-compose -f docker-compose-simple.yml up -d
          
          # Wait for services to be ready
          sleep 30
          
          # Run migrations
          docker-compose -f docker-compose-simple.yml exec -T web python manage.py migrate
          
          # Collect static files
          docker-compose -f docker-compose-simple.yml exec -T web python manage.py collectstatic --noinput
          
          # Health check
          if curl -f http://localhost:8000/ > /dev/null 2>&1; then
            echo "‚úÖ Deployment successful!"
            # Clean up backup if deployment is successful
            rm -rf app_backup
          else
            echo "‚ùå Deployment failed, rolling back..."
            if [ -d "app_backup" ]; then
              rm -rf app_backup
            fi
            exit 1
          fi
          
          # Clean up
          rm -f /tmp/deployment.tar.gz
        EOF
        
    - name: Health Check
      run: |
        sleep 10
        curl -f http://${{ secrets.EC2_HOST }}:8000/ || exit 1
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Deployment successful!"
          echo "üåê Application is available at: http://${{ secrets.EC2_HOST }}:8000"
        else
          echo "‚ùå Deployment failed!"
        fi